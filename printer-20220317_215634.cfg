# Master configuration file for Mercury One Conversion of Ender 5 Plus
# equipped with Stealthburner printhead, and BTT SKR 1.4 Turbo.

##========================== Pin Definitions ========================
## X_STEP_PIN         2.2
## X_DIR_PIN          2.6
## X_ENABLE_PIN       2.1
## X_STOP_PIN         1.29
## E0_DET_PIN         1.26
## X_UART_PIN         1.10


## Y_STEP_PIN         0.19
## Y_DIR_PIN          0.20
## Y_ENABLE_PIN       2.8
## Y_STOP_PIN         1.28
## E1_DET_PIN         1.26
## Y_UART_RX          1.9


## Z_STEP_PIN         0.22
## Z_DIR_PIN          2.11
## Z_ENABLE_PIN       0.21
## Z_STOP_PIN         1.27
## PWR_DET_PIN        1.0
## Z_UART             1.8


## E0_STEP_PIN        2.13
## E0_DIR_PIN         0.11
## E0_ENABLE_PIN      2.12
## E0_UART            1.4

## HE1                2.4    
## HE0                2.7
## BED                2.5
## TH1 (H1 Temp)      0.23
## TH0 (H0 Temp)      0.24
## TB  (Bed Temp)     0.25
## FAN                2.3
## SERVO              2.0
## PROBE	          0.10

## SPI		    (TL)0.26, 0.7, 0.8, (BL)GND, 0.9, +5V 
##===================================================================


#[include neopixel.cfg]
[include stealthburner_leds.cfg]
#[include print_area_bed_mesh.cfg]
[include klicky-probe.cfg]
[include macros.cfg]

#####################################################################
# 	X/Y Stepper Settings
#####################################################################

[stepper_x]
## (B Motor)
step_pin: P2.2
dir_pin: P2.6
enable_pin: !P2.1
rotation_distance: 40
microsteps: 128
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_max: 399
position_endstop: 399
homing_speed: 20   #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: P1.10
interpolate: False
run_current: 0.8
sense_resistor: 0.110
diag_pin: P1.29
driver_SGTHRS: 35 # 255 is most sensitive value, 0 is least sensitive
## After finding maximum_sensitivity and minimum_sensitivity, use a 
## calculator to obtain the recommend sensitivity as minimum_sensitivity + (maximum_sensitivity - minimum_sensitivity)/3

[stepper_y]
## (A Motor)
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 399
position_min: 0
position_max: 399
homing_speed: 20  #Max 100
homing_retract_dist: 0
homing_positive_dir: true


[tmc2209 stepper_y]
uart_pin: P1.9
interpolate: False
run_current: 0.8
sense_resistor: 0.110
diag_pin: P1.28
driver_SGTHRS: 35 # 255 is most sensitive value, 0 is least sensitive

#####################################################################
# 	Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: P1.15
dir_pin: !P1.14
enable_pin: !P1.16
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop # Klicky probe Z endstop
position_max: 400
position_min: -1
[tmc2209 stepper_z]
uart_pin: P1.1
run_current: 0.650

[stepper_z1]
step_pin: P0.22
dir_pin: !P2.11
enable_pin: !P0.21
microsteps: 16
rotation_distance: 4

[tmc2209 stepper_z1]
uart_pin: P1.8
run_current: 0.650

[fan]
pin: P2.3

[mcu]
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_lpc1769_0900010F27903CAF2EA86D5CC52000F5-if00
##--------------------------------------------------------------------

[printer]
kinematics: corexy
max_velocity: 400
max_accel: 3000
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 5.0

#####################################################################
# 	Extruder
#####################################################################

[extruder]
step_pin: P2.13
dir_pin: !P0.11
enable_pin: !P2.12
rotation_distance: 21.66100629	
gear_ratio: 50:10				#BMG Gear Ratio
microsteps: 32
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: P2.7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: P0.24
min_temp: 0
max_temp: 290
max_power: 1.0
min_extrude_temp: 170
control = pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
pressure_advance: 0.05
##	Default is 0.040, leave stock
pressure_advance_smooth_time: 0.040

## E0 
[tmc2209 extruder]
uart_pin: P1.4
interpolate: false
run_current: 0.5
sense_resistor: 0.110


#####################################################################
# 	Bed Heater
#####################################################################

[heater_bed]
heater_pin: P2.5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: P0.25
control: pid
pid_Kp: 69.343
pid_Ki: 1.016
pid_Kd: 1183.162
min_temp: 0
max_temp: 120

#####################################################################
# 	Probe
#####################################################################

[probe]
##	Klicky Probe
pin: ^P0.10      ##^z:P0.10
x_offset: -1.5
y_offset: 19.75
#z_offset: 7.450
speed: 2.5
samples: 3
samples_result: median
sample_retract_dist: 2.0
samples_tolerance: 0.01
samples_tolerance_retries: 5

[bed_mesh]
speed: 120
horizontal_move_z: 10
mesh_min: 20, 20
#mesh_max: 210, 190 # Ender 5 / 5 Pro
mesh_max: 340, 310 # Ender 5 Plus
probe_count: 5,5

#####################################################################
# 	Fan Control
#####################################################################

#[heater_fan hotend_fan]
##	Hotend Fan 
#pin: P2.4
#max_power: 1.0
#kick_start_time: 0.5
#heater: extruder
#heater_temp: 50.0
##	If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0

[fan]
##	Print Cooling Fan - XYE board, Fan Pin
pin: P2.3
kick_start_time: 0.5
##	Depending on your fan, you may need to increase this value
##	if your fan will not start. Can change cycle_time (increase)
##	if your fan is not able to slow down effectively
off_below: 0.10
  
## 	Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 5.650
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.175000, -0.188750, -0.205000, -0.240000, -0.302500
#*# 	-0.092500, -0.107500, -0.125000, -0.090000, -0.072500
#*# 	0.023750, 0.001250, -0.055000, 0.007500, 0.035000
#*# 	0.058750, 0.015000, 0.005000, -0.026250, -0.026250
#*# 	0.040000, 0.057500, -0.026250, -0.058750, -0.177500
#*# tension = 0.2
#*# min_x = 20.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 5
#*# max_y = 310.0
#*# mesh_x_pps = 2
#*# max_x = 340.0
